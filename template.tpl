___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "OneTrust CMP",
  "brand": {
    "id": "github.com_jmpate",
    "displayName": "OneTrust",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Add OneTrust\u0027s Consent Management Platform (CMP) to your website via Google Tag Manager, and integrate seamlessly with Google Consent Mode with this easy-to-use template.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "CMP Settings",
    "displayName": "CMP Settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "Domain",
        "displayName": "Data Domain Script",
        "simpleValueType": true,
        "valueHint": "e.g. d63e8944-3071-4b16-8517-35fedabe0fdf",
        "help": "You can find this information by clicking \"Scripts\" and then \"Production Scripts\" in your tenant. It must be 36 characters.",
        "valueValidators": [
          {
            "type": "STRING_LENGTH",
            "args": [
              36,
              41
            ]
          },
          {
            "type": "REGEX",
            "args": [
              "^(\\w{8})-(\\w{4})-(\\w{4})-(\\w{4})-(\\w{12})(?:[a-z\\-]{5})?$"
            ]
          },
          {
            "type": "NON_EMPTY"
          }
        ],
        "alwaysInSummary": true
      },
      {
        "type": "SELECT",
        "name": "URL",
        "displayName": "src URL",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "cdn.cookielaw.org",
            "displayValue": "cdn.cookielaw.org"
          },
          {
            "value": "cdn-ukwest.onetrust.com",
            "displayValue": "cdn-ukwest.onetrust.com"
          },
          {
            "value": "cookie-cdn.cookiepro.com",
            "displayValue": "cookie-cdn.cookiepro.com"
          },
          {
            "value": "cdn-au.onetrust.com",
            "displayValue": "cdn-au.onetrust.com"
          },
          {
            "value": "cdn-apac.onetrust.com",
            "displayValue": "cdn-apac.onetrust.com"
          }
        ],
        "simpleValueType": true
      }
    ],
    "help": "These settings can be found in the Scripts page of your OneTrust tenant."
  },
  {
    "type": "RADIO",
    "name": "useConsentMode",
    "displayName": "Do you want to use Google Consent Mode?",
    "radioItems": [
      {
        "value": true,
        "displayValue": "Yes"
      },
      {
        "value": false,
        "displayValue": "No"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "PARAM_TABLE",
    "name": "gcmMapping",
    "displayName": "Google Consent Mode Configuration",
    "paramTableColumns": [
      {
        "param": {
          "type": "SELECT",
          "name": "gcmCategory",
          "displayName": "GCM Category",
          "macrosInSelect": false,
          "selectItems": [
            {
              "value": "analytics_storage",
              "displayValue": "analytics_storage"
            },
            {
              "value": "ad_storage",
              "displayValue": "ad_storage"
            },
            {
              "value": "functionality_storage",
              "displayValue": "functionality_storage"
            },
            {
              "value": "personalization_storage",
              "displayValue": "personalization_storage"
            },
            {
              "value": "security_storage",
              "displayValue": "security_storage"
            },
            {
              "value": "ad_user_data",
              "displayValue": "ad_user_data"
            },
            {
              "value": "ad_user_personalization",
              "displayValue": "ad_user_personalization"
            }
          ],
          "simpleValueType": true
        },
        "isUnique": true
      },
      {
        "param": {
          "type": "TEXT",
          "name": "oneTrustCatId",
          "displayName": "OneTrust Category Id",
          "simpleValueType": true,
          "valueHint": "eg. C0002",
          "enablingConditions": [],
          "help": "Leave this blank if you have chosen to map the categories in OneTrust instead of in Google Tag Manager. Values set here will be ignored if you\u0027ve already configured them in OneTrust."
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "RADIO",
          "name": "defaultConsent",
          "displayName": "Global Default Consent",
          "radioItems": [
            {
              "value": "On by default",
              "displayValue": "On by default (opt-out consent)"
            },
            {
              "value": "Off by default",
              "displayValue": "Off by default (opt-in consent)"
            }
          ],
          "simpleValueType": true,
          "enablingConditions": [],
          "help": "Region-specific defaults can be set in the next section."
        },
        "isUnique": false
      }
    ],
    "enablingConditions": [
      {
        "paramName": "useConsentMode",
        "paramValue": true,
        "type": "EQUALS"
      }
    ],
    "newRowButtonText": "Add GCM Category",
    "newRowTitle": "Add Google Consent Mode Category",
    "alwaysInSummary": false,
    "help": "Add the GCM categories you will use and provide their default value and OneTrust category mapping."
  },
  {
    "type": "PARAM_TABLE",
    "name": "regionSpecificBehavior",
    "displayName": "Region-Specific Default Consent Overrides",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "region",
          "displayName": "Region Code",
          "simpleValueType": true,
          "valueHint": "eg. us-ca, gb, fr",
          "textAsList": false,
          "help": "Enter region codes, separated by commas. (eg. us-ca, gb)",
          "valueValidators": [
            {
              "type": "NON_EMPTY"
            }
          ]
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "analytics_storage",
          "displayName": "analytics_storage",
          "selectItems": [
            {
              "value": "On by default",
              "displayValue": "On by default"
            },
            {
              "value": "Off by default",
              "displayValue": "Off by default"
            },
            {
              "value": "Use global default",
              "displayValue": "Use global default"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "Use global default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "ad_storage",
          "displayName": "ad_storage",
          "selectItems": [
            {
              "value": "On by default",
              "displayValue": "On by default"
            },
            {
              "value": "Off by default",
              "displayValue": "Off by default"
            },
            {
              "value": "Use global default",
              "displayValue": "Use global default"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "Use global default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "functionality_storage",
          "displayName": "functionality_storage",
          "selectItems": [
            {
              "value": "On by default",
              "displayValue": "On by default"
            },
            {
              "value": "Off by default",
              "displayValue": "Off by default"
            },
            {
              "value": "Use global default",
              "displayValue": "Use global default"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "Use global default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "personalization_storage",
          "displayName": "personalization_storage",
          "selectItems": [
            {
              "value": "On by default",
              "displayValue": "On by default"
            },
            {
              "value": "Off by default",
              "displayValue": "Off by default"
            },
            {
              "value": "Use global default",
              "displayValue": "Use global default"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "Use global default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "security_storage",
          "displayName": "security_storage",
          "selectItems": [
            {
              "value": "On by default",
              "displayValue": "On by default"
            },
            {
              "value": "Off by default",
              "displayValue": "Off by default"
            },
            {
              "value": "Use global default",
              "displayValue": "Use global default"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "Use global default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "ad_user_data",
          "displayName": "ad_user_data",
          "selectItems": [
            {
              "value": "On by default",
              "displayValue": "On by default"
            },
            {
              "value": "Off by default",
              "displayValue": "Off by default"
            },
            {
              "value": "Use global default",
              "displayValue": "Use global default"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "Use global default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "ad_user_personalization",
          "displayName": "ad_user_personalization",
          "selectItems": [
            {
              "value": "On by default",
              "displayValue": "On by default"
            },
            {
              "value": "Off by default",
              "displayValue": "Off by default"
            },
            {
              "value": "Use global default",
              "displayValue": "Use global default"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "Use global default"
        },
        "isUnique": false
      }
    ],
    "newRowButtonText": "Add region-specific default",
    "newRowTitle": "Add region-specific default",
    "help": "If you would like to have different default consent rules per region, you can enter those defaults here. Any region that is not defined will automatically take the global default set in the previous section.",
    "enablingConditions": [
      {
        "paramName": "useConsentMode",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const setDefaultConsentState = require('setDefaultConsentState');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');
const updateConsentState = require('updateConsentState');
const callInWindow = require('callInWindow');
const copyFromWindow = require('copyFromWindow');
const callLater = require('callLater');
const setInWindow = require('setInWindow');
const Object = require('Object');
const getCookie = require('getCookieValues');
const LOGTAG = "OT.CMP >";
/*
- - - - - - - - - - - - - 
Build script from inputs
- - - - - - - - - - - - -
*/
let domain = data.Domain;
let scriptURL = 'https://' + data.URL + '/scripttemplates/otSDKStub.js?did=' + data.Domain;

const otData = {
    domainId: domain,
    stubURL: scriptURL
};

log(LOGTAG, 'Script Data to load', otData);

/*
- - - - - - - - - - - - - - - - - - - - - - - - -
Set GCM consent key settings defaults from inputs
- - - - - - - - - - - - - - - - - - - - - - - - -
*/

//Consent enums
const CONSENT = {
      denied: 'denied',
      granted: 'granted'
};

const CONSENT_DEFAULT = {
  denied:'Off by default',
  granted: 'On by default',
  global:'Use global default'
};

//Conditional block - only execute if the user wants to use GCM
if(data.useConsentMode){
  log(LOGTAG,"Setting up Google Consent Mode defaults.");

  let defaultGCMConsentState = {"wait_for_update": 500}; //set default wait
  data.gcmMapping && data.gcmMapping.forEach(record =>{
    defaultGCMConsentState[record.gcmCategory] = isConsented(record.defaultConsent == CONSENT_DEFAULT.granted);
  });
  
  setDefaultConsentState(defaultGCMConsentState); //set global default consent
  
  //Region specific default consent
  data.regionSpecificBehavior && data.regionSpecificBehavior.forEach(regionRule => {
    let regionCodes = parseRegionString(regionRule.region);
    let regionalDefault = {
      "wait_for_update": 500,
      "region":regionCodes
    };
    
    Object.entries(regionRule).forEach(e => {
      const key = e[0];
      const value = e[1];
      if(value != CONSENT_DEFAULT.global && key != "region"){ //if there is an override, add it as a regional default
        regionalDefault[key] = isConsented(value == CONSENT_DEFAULT.granted);
      }
    });
    setDefaultConsentState(regionalDefault);
  });
  
  //Update with previous consent from OneTrust cookie if it already exists
  
  let consentCookie = getCookie("OptanonConsent") && getCookie("OptanonConsent")[0];
  if(consentCookie){
    let previousConsent = {};
    data.gcmMapping.forEach( category => {
      previousConsent[category.gcmCategory] = isCategoryConsentInCookie(consentCookie, category.oneTrustCatId);
    });
    updateConsentState(previousConsent);
  }

  
  //Add callback to window so that GCM is updated when consent changes
  setInWindow("otEventListeners", [{event:"consent.changed", listener:updateConsent}], false);
  
}else{
  log(LOGTAG, "Google Consent Mode not being used - setup skipped!");
}

/*
- - - - - - - 
Consent update callback function
- - - - - - - 
*/
function updateConsent() {
  const domainData = callInWindow('OneTrust.GetDomainData');
  const gcmIsEnabledInOneTrust = domainData.GoogleConsent.GCEnable;
  if(gcmIsEnabledInOneTrust){
    log(LOGTAG,"NOTICE: Using category mappings inside of OneTrust instead of in GTM. Mapping in GTM will be ignored.");
    callInWindow("OneTrust.UpdateGCM", () => {});
    return;
  }
  
  const otActiveGroups = copyFromWindow('OnetrustActiveGroups');
  const consentArray = otActiveGroups.split(",");

  let updateData = {};
  data.gcmMapping.forEach(e=>{
    if(!e.oneTrustCatId){
      log(LOGTAG,"Skipping update for" + e.gcmCategory + "because a valid OneTrust ID was not provided in GTM.");
      return;
    }
    updateData[e.gcmCategory] = isConsented(consentArray.indexOf(e.oneTrustCatId) > -1);
  });
  log(LOGTAG,"Updating Google Consent Mode", updateData);
  updateConsentState(updateData);
}

/*
- - - - - - - 
Helper Functions
- - - - - - - 
*/

function isConsented(logicalTest){
  return logicalTest ? CONSENT.granted : CONSENT.denied;
}

function isCategoryConsentInCookie(cookie,otCategoryId){
  return isConsented(cookie.indexOf(otCategoryId + ":1") > -1);
}

function parseRegionString(regionString){
  return regionString.split(",")
                     .map(regCode => regCode.trim().toUpperCase()) //remove spaces, capitalize
                     .filter(regCode=>regCode!=""); //remove blanks
}

/*
- - - - - - - 
Insert script
- - - - - - - 
*/

if (queryPermission('inject_script', scriptURL)) {
    injectScript(scriptURL, data.gtmOnSuccess, data.gtmOnFailure);
} else {
        data.gtmOnFailure();
    log(LOGTAG,'OneTrust Script does not have permission to be injected.');
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "OnetrustActiveGroups"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "OneTrust.GetDomainData"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "OneTrust.UpdateGCM"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "OneTrust"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "otEventListeners"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtag"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cookie-cdn.1trust.app/*"
              },
              {
                "type": 1,
                "string": "https://cdn.cookielaw.org/*"
              },
              {
                "type": 1,
                "string": "https://cdn-ukwest.onetrust.com/*"
              },
              {
                "type": 1,
                "string": "https://cookie-cdn.cookiepro.com/*"
              },
              {
                "type": 1,
                "string": "https://cdn-au.onetrust.com/*"
              },
              {
                "type": 1,
                "string": "https://cdn-apac.onetrust.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "OptanonConsent"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 10/4/2022, 11:18:53 AM


